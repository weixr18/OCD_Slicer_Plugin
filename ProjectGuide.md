# OCD_Slicer_Plugin 项目概览

## 1 简介

OCD_Slicer_Plugin是一个slicer插件项目，通过对识别病人肺部CT图像的分析，实现新冠肺炎(COVID-19)的检测。

项目贡献者：魏欣然，陈炜翔，门恺文，韩沛轶，刘博伦

## 2 项目进度

### 已经实现

+ slicer插件前端
+ 后端-本地服务器
+ 后端-分割功能模块
+ 后端-检测功能模块
+ 功能-支持用户设置切片范围、切片间距
+ 功能-肺分割插值填充和显示

### 正在开发

+ 前端：
    + 综合诊断分数显示
    + 逐切片分类结果交互式显示（色彩条可视化）
    + **诊断反馈（错误切片标记）界面**
    + 批处理结果查看界面

+ 后端：
    + **独立批处理数据模块**
        + 简单的图形界面，用户指定批数据路径，输出路径
        + 批处理脚本
        + 硬盘读入数据，切片分数、分割输出到硬盘
    + 批处理结果查看模块

### 待解决问题

+ MRMLScene自动定位至图像中心
+ 分割scene（黄色）展示方向自动设置为冠状面
+ 分割算法不稳定问题（会影响部分切片的打分）

### 未来需求

+ 肺叶分割（现在只是把整个肺从CT中分出来）
+ 性能提升：模型压缩、准确率提升等

### 当前性能状况：

+ 时间：完整的一次CT图像检测需要约10s（Intel i7 8th Gen CPU）
  其中首次加载模型需要40s。
+ 内存：需占用约2GB

## 3 项目结构

项目主要文件均在OpenCOVID_Detecter目录下。下面是这个目录的结构和模块功能简介。

    -CT_Detect/

    CT检测插件模块，目前唯一的模块。
    模块从Slicer导入病人CT图像，进行切片——分割——评分后，将结果显示在前端界面上，辅助医生进行新冠肺炎诊断。

    实现方式：
    插件加载时，后端服务器进程（python3.6）待命。
    开始按钮点击后，前端通过socket将CT体数据（numpy数组）传递给后端进程。后端基于pytorch，逐切片进行深度神经网络分类。分类完毕后，将分类结果同样通过socket传回前端，在Slicer界面上进行展示。

        --Testing/
        测试脚本。目前无。

        --Resources/
        各类资源文件，包括前端ui设计文件

        --old/
        弃用代码

            --grad_cam_py3.py
            生成热图的实现文件。输入判断为正类的体数据切片，输出每张切片对应的热图。

        --Utils/

        后端组件库。后端所有实现代码均在此文件夹下。

            --data_py3.py
            进行数据预处理，包括大小调整、范围调整、切片等

            --segment_py3.py
            对每个切片生成肺分割。目前采用简单阈值+连通域算法，对大块肺边缘病变不稳定。

            --detect_py3.py
            对每个切片进行CT分类。输入为CT切片和对应的mask（即分割）。

            ---net2d_py3.py
            各种卷积网络模型。目前使用其中的resnet152作为分类网络。（resnet，残差网络，2015年由KaiMing He等提出。）

        --CT_Detect.py
        前端和前后端接口文件。

            Client
            客户端通信类。具体通信的实现。

            CT_DetectWidget
            插件模块窗口类，MVC中的View。负责GUI展示、用户交互，即前端。

            CT_DetectLogic
            插件模块逻辑类。MVC中的Control。在Client和Widget间传递参数。

        --data_front.py
        前端数据处理模块。目前仅有分割插值。

        --server_py3.py
        后端服务器。负责与前端通信、调用各后端模块功能。       

        --batch_process_py3.py
        批处理服务脚本。可以以单独进程批量处理一组数据。

        --CMakeLists.txt
        C++项目构建的时候的make命令。目前无用

    -model/
    
    训练好的神经网络模型权重。

